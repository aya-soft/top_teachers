# Домашка #1 (08.06.2025)

## Кто выполнил

- Антон Агеев
- anthony.ageev@gmail.com
- @aya_soft

## Event Storming в Miro

[https://miro.com/app/board/uXjVIqiCZUg=/](https://miro.com/app/board/uXjVIqiCZUg=/)

## Распределение процессов по сервисам

- Управление и создание заданий:
  - Менеджер создает задание
  - Менеджер редактирует задание
  - Менеджер назначает задание кандидату
  

- Найм учителей:
  - Кандидат регистрируется
  - Кандидат заходит в систему
  - Кандидат видит задание
  - Кандидат отправляет решение задания
  - Кандидат переводится в учителя


- Расчет бонусов менеджерам:
  - Менеджеру начисляется бонус за создание задания
  - Менеджеру начисляется бонус за правильное задание
  - Менеджеру списывается бонус за неправильное задание
  - Раз в месяц менеджеру выплачивается бонус и обновляется баланс (если положительный)

## Разбор проблем

### [Problem-010]
Долго определяется правильность выполнения задания от кандидата. Это вызывает задержки, которые бесят менеджеров и учителей.

### Анализ

Рассмотрим результаты EventStorming и схемы взаимодействия сервисов.

Процесс "Кандидат отправляет решение задания" для кейса "Задание одобрено" состоит из множества шагов:
- Рассчитать рейтинг
- Начислить бонус менеджеру
- Перевести кандидата в учителя
- Назначить менеджера на переделку (если > 10)

По всей видимости для достижения результата будут использованы следующие связи:
- [COMM-010]
- [COMM-020]
- [COMM-030]
- [COMM-040] или [COMM-050]
- [COMM-060]

Связей много, они почти все синхронные, поэтому все тормозит

### Решение

Связи, которые строят неправильные зависимости: [COMM-040] и [COMM-050] - это команды!

Сервис Найма не должен знать ничего о Сервисе Бонусов.

Если Сервису Бонусов потребуется узнать Рейтинг конкретного задания, он сам сможет сходить в Сервис Найма и узнать или
мы ему можем эту информацию в событии сразу передать.

Событие TaskRatig недостаточное для реализации, так как не триггерит никакое действие дальше, а лишь замедляет текущий флоу.

Меняем событие TaskRatig [COMM-060] на 2 события "Решение одобрено" и "Решение забраковано"
Внутри событий передаем рейтинг задания.

Удаляем связи [COMM-040] и [COMM-050], вместо них будут триггериться действия внутри Сервиса Бонусов:
- на событие "Решение одобрено" триггерится действие "Начислить бонус"
- на событие "Решение забраковано" триггерится действие "Списать бонус"

Как вариант можно сделать асинхронной и связь [COMM-030], но и так мы избавились от зависимости от целого сервиса.

### [Problem-020]
Кандидаты в учителя читерят систему в месте, где простое задание должно усложниться, но этого ещё не произошло.

Для этого они собираются в группы, где делятся лёгкими заданиями между собой, и, пока задание обновляется, пачкой выполняют лёгкие версии.

### Анализ

Кажется тут со связями все нормально, но возможно стоит подтюнить процесс "Отправить решение задания"

### Решение

На первый взгляд кажется, что можно при попытке кандидата отправить решение задания, 
которое уже обновилось, не принимать его, а просить кандидата выполнить новую версию. 

### [Problem-030]
Логика начисления бонусов некорректна из-за ошибки с рейтингом задания.

Во время начисления бонусов во время изменения рейтинга, происходит задержка, которая не удовлетворяет бизнес (нужно моментально).

### Анализ

Это происходит из-за того, что связи, используемые для достижения результата разнородные: одна связь синхронная, а вторая асинхронная

### Решение

Меняем событие TaskRatig [COMM-060] на 2 события "Решение одобрено" и "Решение забраковано"
Внутри событий передаем рейтинг задания.

### [Problem-040]
Медленно начисляются бонусы менеджерам, потому что много кандидатов в учителя. 

Иногда вся система падает и не восстанавливается.

### Анализ

Это из-за того, что связи - [COMM-040], [COMM-050], [COMM-080] - синхронные.

Они создают огромную нагрузку на Сервис Бонусов.

Теряется устойчивость Сервиса.

### Решение

Удаляем синхронные связи [COMM-040], [COMM-050], [COMM-080], вместо них добавляем события, на которые будет подписан Сервис Бонусов.

Удаляем связи [COMM-040], [COMM-050] и [COMM-080] вместо них будут триггериться действия внутри Сервиса Бонусов:
- на событие "Решение одобрено" триггерится действие "Начислить бонус"
- на событие "Решение забраковано" триггерится действие "Списать бонус"
- на событие "Задача создана" триггерится действие "Начислить бонус"

### [Problem-050]
В UI может отобразиться ошибка каких-то запросов после успешного выполнения задания. 

Разработчики объясняют это поведение вызовом сервиса оплаты и создания заданий.

### Анализ

Это из-за того, что связи - [COMM-040], [COMM-050], [COMM-080] - синхронные.

Они создают огромную нагрузку на Сервис Бонусов.

Теряется устойчивость Сервиса.

### Решение

То же

### [Problem-060]
Нужно сократить расходы на скейлинг сервиса заданий. Сейчас дорого.

### Анализ

Что создает нагрузку на Сервис Управления и Создания Заданий?

Теряется устойчивость Сервиса.

### Решение

[COMM-030] Делаем асинхронной чтобы снизить нагрузку на Сервис Управления и Создания Заданий.

[COMM-090] Либо описана неправильно, либо я что-то не понял. Список кандидатов должен храниться в Сервисе Найма.

Когда Менеджер садится назначать задания кандидатам, он должен загружать список кандидатов из Сервиса Найма.

Вообще тут стоит подумать об автоматизации назначения заданий Кандидатам (либо по критериям, либо с помощью AI)

### [Problem-070]
Менеджерам иногда начисляются бонусы дважды. 

Это связано с тем, что, когда кандидаты в учителя отправляют то же самое задание повторно, система тупит [Problem-050].

Разработчики объясняют тем, что управление заданиями падает, а бонусами — нет. Из-за этого бонусы попадают в два одинаковых запроса.

## Анализ

Сходу не пойму как это можно решить изменением связей.

Мысли сразу идут в сторону: очередности операций, блокировок и распределенных транзакций.

Но кажется это пока не нужно и сложно.

### [Problem-080]
Упавший сервис создания заданий или бонусов кладёт всю систему, и учителя не могут выполнять задания.

## Анализ

Это из-за синхронных операций, которые создают нагрузку на Сервис Заданий и делают систему хрупкой.

## Решение

[COMM-030] Делаем асинхронной чтобы снизить нагрузку на Сервис Управления и Создания Заданий.

Удаляем связь [COMM-080] вместо нее будет триггериться действие внутри Сервиса Бонусов:
- на событие "Задача создана" триггериться действие "Начислить бонус"

[COMM-030] разворачиваем в обратную сторону (Сервис бонусов запрашивает инфу о Менеджере у Сервиса Заданий)

[COMM-090] разворачиваем в обратную сторону (Сервис Заданий запрашивает список Кандидатов у Сервиса Найма)

### [Problem-090]
Фичи выходят слишком медленно. 

Это связано с тем, что для выполнения любой фичи нужно изучить всю систему и проверить, что ничего не упало. 

Короче, разработчики сами не понимают, как работает система вне отдельного сервиса.

## Анализ

Это из-за лишних синхронных операций, которые создают ненужный coupling.

## Решение

То же

### [Problem-100]
Данные теряются вокруг логики выполнения заданий кандидатами в учителя.

## Анализ

Это из-за многошагового процесса "Отправить решение задания", который получается очень долгим.

Из-за синхронных шагов создается огромная нагрузка на Сервис Заданий.

## Решение

То же


## Изменения в связях

| Номер связи | Связь сейчас | Связь будет                                        | Номера проблем | Почему изменили                                            |
|-------------|--------------|----------------------------------------------------|----------------|------------------------------------------------------------|
| [COMM-010]  |              |                                                    |                |                                                            |
| [COMM-020]  |              |                                                    |                |                                                            |
| [COMM-030]  | Синхронная   | Асинхронная отправка события через kafka           |                |                                                            |
|             |              | Событие "Решение одобрено"                         |                |                                                            |
|             |              |                                                    |                |                                                            |
| [COMM-040]  | Синхронная   | Асинхронная отправка события через kafka           | [Problem-010]  |                                                            |
|             |              | Событие "Решение одобрено"                         |                |                                                            |
|             |              |                                                    |                |                                                            |
| [COMM-050]  | Синхронная   | Асинхронная отправка события через kafka           | [Problem-010]  |                                                            |
| [COMM-060]  | Асинхронная  | Синхронный вызов из Сервиса Бонусов в Сервис Найма |                | Сервис Бонусов                                             |
| [COMM-070]  | Синхронная   | Синхронная, но поменяет направление                |                | Сервис Заданий не должен знать о Сервисе Бонусов           |
| [COMM-080]  | Синхронная   | Асинхронная отправка события через kafka           | [Problem-010]  | Не требуется немедленный расчет. Событие инициирует запрос |
|             |              | Событие "Задание создано"                          |                | информации о менеджере и обновление его баланса            |
|             |              |                                                    |                |                                                            |
| [COMM-090]  |              |                                                    |                |                                                            |
